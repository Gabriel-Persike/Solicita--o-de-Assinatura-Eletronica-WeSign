function defineStructure(){}function onSync(e){}var codArquivo,versao,codRegistro,pastaOrigem,descricao,user,remetente,parametroGeral,statusAssinatura2="Enviando para assinatura",statusAssinatura3="Pendente Assinatura",serviceCode="wesigner",tempo=0,identificador="WeSign V3.1.0",ds="ds_upload_wesign_manual",pk="";function createDataset(e,t,a){var r=DatasetBuilder.newDataset(),o=[];imprimeLog("INICIO");t=getParams(t);parametroGeral=parametroGeral();var i=DatasetFactory.getDataset("ds_form_aux_wesign",null,[DatasetFactory.createConstraint("metadata#active",!0,!0,ConstraintType.MUST),DatasetFactory.createConstraint("statusAssinatura",statusAssinatura2,statusAssinatura2,ConstraintType.MUST),DatasetFactory.createConstraint("codArquivo",t.codArquivo,t.codArquivo,ConstraintType.MUST)],null);if(i&&0<i.rowsCount)for(var s,n,c,d,u,m=0;m<i.rowsCount;m++)codArquivo=parseInt(i.getValue(m,"codArquivo")),codRegistro=parseInt(i.getValue(m,"metadata#id")),imprimeLog("codArquivo",codArquivo),imprimeLog("codRegistro",codRegistro),o.indexOf(codArquivo)<0&&(imprimeLog("Enviando documento",pk=codArquivo),d=buscaDocumento(codArquivo,codRegistro),aguardar(tempo),d&&(versao=parseInt(i.getValue(m,"vrArquivo")),pastaOrigem=parseInt(i.getValue(m,"codPasta")),descricao=String(d.description),user=String(i.getValue(m,"codRemetente")),signers=JSON.parse(String(i.getValue(m,"jsonSigners"))),s=[],n=[],0<signers.length&&signers.map(function(e){e.tipo&&("E"==e.tipo?s.push({type:"Signer",step:e.etapa||"1",user:{name:e.nome,identifier:hex2a(e.cpf),email:hex2a(e.email)},allowElectronicSignature:!0}):"D"==e.tipo?s.push({type:"Signer",step:e.etapa||"1",user:{name:e.nome,identifier:hex2a(e.cpf),email:hex2a(e.email)}}):"A"==e.tipo?s.push({type:"Approver",step:e.etapa||"1",user:{name:e.nome,identifier:hex2a(e.cpf),email:hex2a(e.email)}}):"O"==e.tipo&&n.push({user:{name:e.nome,identifier:hex2a(e.cpf),email:hex2a(e.email)}}))}),descricao&&(aguardar(tempo),u=getBytes(),aguardar(tempo),u&&(aguardar(tempo),c=upload(u),aguardar(tempo),c&&(aguardar(tempo),remetente=buscaRemetente(user),d="",(u=DatasetFactory.getDataset("document",null,[DatasetFactory.createConstraint("documentPK.documentId",codArquivo,codArquivo,ConstraintType.MUST)],null))&&(d=String(u.getValue("0","mimetype"))),create(c,s,signers,n,d),o.push(codArquivo))))),imprimeLog("Fim Enviando Documento",codArquivo));return imprimeLog("TERMINO"),r}function parametroGeral(){var e=DatasetFactory.getDataset("ds_wesign_param_geral",null,[DatasetFactory.createConstraint("metadata#active",!0,!0,ConstraintType.MUST)],null);if(e)return{userIntegrator:hex2a(String(e.getValue(0,"metadata3"))),password:hex2a(String(e.getValue(0,"metadata5"))),codFormAuxiliar:parseInt(e.getValue(0,"codFormAuxiliar")),matricula:hex2a(String(e.getValue(0,"metadata4"))),companyId:getValue("WKCompany"),codPastaExcluidos:parseInt(e.getValue(0,"codPastaExcluidos")),codFormAssinantes:parseInt(e.getValue(0,"idFormAssinante"))}}function upload(e){imprimeLog("upload INICIO");var t=getValue("WKCompany");try{var a=fluigAPI.getAuthorizeClientService(),r={companyId:t+"",serviceCode:serviceCode,endpoint:"/api/uploads/bytes",method:"POST",timeoutService:"5000",params:{bytes:e},options:{encoding:"UTF-8"},headers:{"content-type":"application/json;charset=UTF-8"}},a=a.invoke(JSON.stringify(r));imprimeLog("Retorno Upload",a.getResult());r=JSON.parse(a.getResult());if(r){if(r.id)return r.id;updateErrorMessage("PORTAL - Ocorreu um erro ao realizar o upload. Motivo: "+a.getResult()+" Origem: ds_upload_wesign - upload()"),imprimeLog("PORTAL - Ocorreu um erro ao realizar o upload. Motivo: "+a.getResult()+" Origem: ds_upload_wesign - upload()")}else updateErrorMessage("PORTAL - Sem retorno ao realizar o upload. Motivo: "+a.getResult()+" Origem: ds_upload_wesign - upload()"),imprimeLog("PORTAL - Sem retorno ao realizar o upload. Motivo: "+a.getResult()+" Origem: ds_upload_wesign - upload()")}catch(e){throw updateErrorMessage("PORTAL - Erro ao fazer o upload na wesign. Motivo: "+e.message+" Origem: ds_upload_wesign - upload()"),imprimeLog("PORTAL - Erro ao fazer o upload na wesign. Motivo: "+e.message+" Origem: ds_upload_wesign - upload()"),e.message}imprimeLog("TERMINO")}function create(e,t,a,r,o){imprimeLog("create INICIO"),imprimeLog("Formato Arquivo",o),o=o||"application/pdf";var i=getValue("WKCompany"),s={files:[{displayName:descricao,id:e,name:descricao,contentType:String(o)}],flowActions:t,observers:r};try{var n=fluigAPI.getAuthorizeClientService(),c={companyId:i+"",serviceCode:serviceCode,endpoint:"/api/documents",method:"POST",timeoutService:"5000",params:s,options:{encoding:"UTF-8"},headers:{"content-type":"application/json;charset=UTF-8"}};imprimeLog("Parametros enviados",JSON.stringify(c));n=n.invoke(JSON.stringify(c));imprimeLog("Retorno Webservice",n.getResult());var d=JSON.parse(n.getResult());if(d.code?updateErrorMessage("PORTAL WeSign - Ocorreu um erro ao realizar o upload. Motivo: "+d.message+" Origem: ds_upload_wesign - upload()"):d=d[0],d)if(d.documentId){imprimeLog("Realizado Create");c=updateSignerInfo(a,d.documentId);c&&(a=c),updateErrorMessage("");try{var u=ServiceManager.getServiceInstance("ECMCardService_wesign"),m=u.instantiate("com.totvs.technology.ecm.dm.ws.ECMCardServiceService").getCardServicePort(),g=u.instantiate("com.totvs.technology.ecm.dm.ws.CardFieldDtoArray"),l=u.instantiate("com.totvs.technology.ecm.dm.ws.CardFieldDto"),p=new Array;l.setField("statusAssinatura"),l.setValue(statusAssinatura3),p.push(l),(l=u.instantiate("com.totvs.technology.ecm.dm.ws.CardFieldDto")).setField("chaveArquivo"),l.setValue(d.documentId),p.push(l),(l=u.instantiate("com.totvs.technology.ecm.dm.ws.CardFieldDto")).setField("idCreate"),l.setValue(d.uploadId),p.push(l),(l=u.instantiate("com.totvs.technology.ecm.dm.ws.CardFieldDto")).setField("jsonSigners"),l.setValue(JSON.stringify(a)),p.push(l),(l=u.instantiate("com.totvs.technology.ecm.dm.ws.CardFieldDto")).setField("dataEnvio"),l.setValue(getTime("data")),p.push(l),(l=u.instantiate("com.totvs.technology.ecm.dm.ws.CardFieldDto")).setField("horaEnvio"),l.setValue(getTime("hora")),p.push(l),(l=u.instantiate("com.totvs.technology.ecm.dm.ws.CardFieldDto")).setField("intDataEnvio"),l.setValue(getTime("dataInt")),p.push(l),g.getItem().addAll(p),m.updateCardData(i,parametroGeral.userIntegrator,parametroGeral.password,codRegistro,g)}catch(e){throw updateErrorMessage("FLUIG - Erro ao atualizar os campos auxiliares. Motivo: "+e.message+" Origem: ds_upload_wesign - create()"),e.message}}else updateErrorMessage("PORTAL - Não foi possível realizar o create. Motivo: "+n.getResult()+" Origem: ds_upload_wesign - create()")}catch(e){throw updateErrorMessage("FLUIG - Erro ao fazer o create na wesign. Motivo: "+e.message+" Origem: ds_upload_wesign - create()"),e.message}imprimeLog("create TERMINO")}function getBytes(){imprimeLog("getBytes INICIO");var e=getValue("WKCompany");try{for(var t,a,r=[],o=ServiceManager.getService("ECMDocumentService_wesign").getBean().instantiate("com.totvs.technology.ecm.dm.ws.ECMDocumentServiceService").getDocumentServicePort().getDocumentContent(parametroGeral.userIntegrator,parametroGeral.password,e,codArquivo,parametroGeral.matricula,versao,descricao),i=0;i<o.length;++i)o[i]<0?(t=o[i],a=parseInt(t)+256,r.push(a)):r.push(o[i]);return imprimeLog("getBytes TERMINO"),r}catch(e){throw updateErrorMessage("FLUIG - Erro ao recuperar os bytes do arquivo. Motivo:"+e.message+" Origem: ds_upload_wesign - getBytes()"),imprimeLog("getBytes TERMINO"),e.message}}function buscaRemetente(e){imprimeLog("buscaRemetente INICIO");e=DatasetFactory.getDataset("colleague",null,[DatasetFactory.createConstraint("active",!0,!0,ConstraintType.MUST),DatasetFactory.createConstraint("colleaguePK.colleagueId",e,e,ConstraintType.MUST)],null);if(0<e.rowsCount)return[String(e.getValue(0,"colleagueName")),String(e.getValue(0,"mail"))];imprimeLog("buscaRemetente TERMINO")}function buscaDocumento(e,t){imprimeLog("buscaDocumento INICIO");var a=getValue("WKCompany");try{var r=ServiceManager.getService("ECMDocumentService_wesign").getBean().instantiate("com.totvs.technology.ecm.dm.ws.ECMDocumentServiceService").getDocumentServicePort();if(retorno=r.getActiveDocument(parametroGeral.userIntegrator,parametroGeral.password,a,e,parametroGeral.matricula),retorno)return{id:retorno.getItem().get(0).getDocumentId(),description:retorno.getItem().get(0).getPhisicalFile()};try{var o=ServiceManager.getServiceInstance("ECMCardService_wesign"),i=o.instantiate("com.totvs.technology.ecm.dm.ws.ECMCardServiceService").getCardServicePort(),s=o.instantiate("com.totvs.technology.ecm.dm.ws.CardFieldDtoArray"),n=o.instantiate("com.totvs.technology.ecm.dm.ws.CardFieldDto");n.setField("statusAssinatura"),n.setValue("Excluido");o=new Array;o.push(n),s.getItem().addAll(o),i.updateCardData(a,parametroGeral.userIntegrator,parametroGeral.password,t,s)}catch(e){throw updateErrorMessage("FLUIG - Erro ao localizar documento na base. Motivo: "+e.message+" Origem: ds_upload_wesign - buscaDocumento()"),e.message}return imprimeLog("buscaDocumento TERMINO"),!1}catch(e){throw updateErrorMessage("FLUIG - Erro ao recuperar os dados do documento. Motivo: "+e.message+" Origem: ds_upload_wesign - buscaDocumento()"),e.message}}function updateErrorMessage(e){imprimeLog("updateErrorMessage INICIO"),imprimeLog("Mensagem",e);var t=getValue("WKCompany");try{var a=ServiceManager.getServiceInstance("ECMCardService_wesign"),r=a.instantiate("com.totvs.technology.ecm.dm.ws.ECMCardServiceService").getCardServicePort(),o=a.instantiate("com.totvs.technology.ecm.dm.ws.CardFieldDtoArray"),i=new Array,s=a.instantiate("com.totvs.technology.ecm.dm.ws.CardFieldDto");s.setField("msgErro"),s.setValue(e),i.push(s),(s=a.instantiate("com.totvs.technology.ecm.dm.ws.CardFieldDto")).setField("dataEnvio"),s.setValue(getTime("data")),i.push(s),(s=a.instantiate("com.totvs.technology.ecm.dm.ws.CardFieldDto")).setField("horaEnvio"),s.setValue(getTime("hora")),i.push(s),(s=a.instantiate("com.totvs.technology.ecm.dm.ws.CardFieldDto")).setField("intDataEnvio"),s.setValue(getTime("dataInt")),i.push(s),o.getItem().addAll(i),r.updateCardData(t,parametroGeral.userIntegrator,parametroGeral.password,codRegistro,o)}catch(e){throw updateErrorMessage(e.message),e.message}imprimeLog("updateErrorMessage TERMINO")}function a2hex(e){for(var t=[],a=0,r=(e=String(e)).length;a<r;a++){var o=Number(e.charCodeAt(a)).toString(16);t.push(o)}return t.join("")}function hex2a(e){for(var t=String(e),a="",r=0;r<t.length&&"00"!==t.substr(r,2);r+=2)a+=String.fromCharCode(parseInt(t.substr(r,2),16));return a}function getTime(e){var t=new Date,a=parseInt(t.getDate())<10?"0"+t.getDate().toString():t.getDate().toString(),r=parseInt(t.getMonth()+1)<10?"0"+(t.getMonth()+1).toString():(t.getMonth()+1).toString(),o=t.getFullYear().toString(),i=a+"/"+r+"/"+o,t=("0"+t.getHours()).slice(-2)+":"+("0"+t.getMinutes()).slice(-2)+":"+("0"+t.getSeconds()).slice(-2);return"data"==e?i:"hora"==e?t:"dataInt"==e?o+r+a:void 0}function updateSignerInfo(e,r){imprimeLog("updateSignerInfo INICIO");try{var t=fluigAPI.getAuthorizeClientService(),a={companyId:getValue("WKCompany")+"",serviceCode:serviceCode,endpoint:"/api/documents/"+r,method:"GET",timeoutService:"180",options:{encoding:"UTF-8"},headers:{"content-type":"application/json;charset=UTF-8"}};imprimeLog("Parametros enviados",JSON.stringify(a));a=t.invoke(JSON.stringify(a));imprimeLog("Retorno Webservice",a.getResult());a=JSON.parse(a.getResult());return a&&(a.flowActions&&a.flowActions.forEach(function(a){e.forEach(function(e){e.signerId||e.flowActionId||(a.user.identifier?a.user.identifier==checkCPF(hex2a(e.cpf))&&(e.signerId=a.user.id,e.flowActionId=a.id):a.user.email==hex2a(e.email)&&(e.signerId=a.user.id,e.flowActionId=a.id));var t=updateSignerUrl(e,r);t&&(e.signUrl=t)})}),a.observers&&a.observers.forEach(function(a){e.forEach(function(e){e.signerId||e.flowActionId||(a.user.identifier?a.user.identifier==checkCPF(hex2a(e.cpf))&&(e.signerId=a.user.id,e.flowActionId=a.id):a.user.email==hex2a(e.email)&&(e.signerId=a.user.id,e.flowActionId=a.id));var t=updateSignerUrl(e,r);t&&(e.signUrl=t)})})),imprimeLog("updateSignerInfo TERMINO"),e}catch(e){imprimeLog("updateSignerInfo ERRO",e.message)}imprimeLog("updateSignerInfo TERMINO")}function updateSignerUrl(e,t){imprimeLog("updateSignerUrl INICIO");var a="";try{var r=fluigAPI.getAuthorizeClientService(),o={companyId:getValue("WKCompany")+"",serviceCode:serviceCode,endpoint:"/api/documents/"+t+"/action-url",method:"POST",timeoutService:"180",params:{identifier:String(hex2a(e.cpf)),emailAddress:String(hex2a(e.email)),requireEmailAuthentication:!0},options:{encoding:"UTF-8"},headers:{"content-type":"application/json;charset=UTF-8"}};imprimeLog("Parametros enviados",JSON.stringify(o));o=r.invoke(JSON.stringify(o));imprimeLog("Retorno Webservice",o.getResult());o=JSON.parse(o.getResult());o&&o.hasOwnProperty("url")&&(a=o.url)}catch(e){imprimeLog("updateSignerUrl ERRO",e.message)}return imprimeLog("updateSignerUrl TERMINO"),a}function checkCPF(e){return 0<e.indexOf(".")&&0<e.indexOf("-")?e.split(".").join("").split("-").join(""):e}function getParams(t){const a={};if(t)for(let e=0;e<t.length;e++)a[t[e].fieldName]=String(t[e].initialValue);return a}function imprimeLog(e,t){log.info("###### "+identificador+" | "+ds+" ("+pk+") - "+(t?e+": "+t:e))}function aguardar(e){java.util.concurrent.TimeUnit.SECONDS.sleep(Number(e))}